<!-- <!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>OOGA BOOGA!</title>
	</head>
	<body>
		<h1 id="heading"></h1>
		<p>OOGA BOOGA.</p>
		<button id="button" type="button">Fetch a random UUID</button>
		<output id="random" for="button"></output>
		<script>
			fetch('/message')
				.then((resp) => resp.text())
				.then((text) => {
					const h1 = document.getElementById('heading');
					h1.textContent = text;
				});

			const button = document.getElementById("button");
			button.addEventListener("click", () => {
				fetch('/random')
					.then((resp) => resp.text())
					.then((text) => {
						const random = document.getElementById('random');
						random.textContent = text;
					});
			});
		</script>
	</body>
</html> -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Armonia • AI Assistant</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color-scheme: dark;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top, #24263a, #050509);
      }

      .chat-shell {
        width: min(480px, 100% - 2rem);
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        background: rgba(10, 10, 18, 0.95);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
        overflow: hidden;
      }

      .chat-header {
        padding: 0.9rem 1.1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      .chat-avatar {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: conic-gradient(from 180deg, #ffb347, #ffcc33, #66ccff, #9b5cff, #ffb347);
        padding: 2px;
      }

      .chat-avatar-inner {
        width: 100%;
        height: 100%;
        border-radius: inherit;
        background: radial-gradient(circle at 30% 30%, #1a1b29, #050509);
      }

      .chat-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .chat-subtitle {
        font-size: 0.75rem;
        opacity: 0.7;
      }

      .chat-log {
        flex: 1;
        padding: 0.75rem 1rem 0.75rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .msg-row {
        display: flex;
      }

      .msg-row.user {
        justify-content: flex-end;
      }

      .msg-row.assistant {
        justify-content: flex-start;
      }

      .msg-bubble {
        max-width: 80%;
        padding: 0.5rem 0.75rem;
        border-radius: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .msg-row.user .msg-bubble {
        background: linear-gradient(135deg, #4e8cff, #7a5cff);
        color: #fdfdfd;
        border-bottom-right-radius: 4px;
      }

      .msg-row.assistant .msg-bubble {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #f3f3f6;
        border-bottom-left-radius: 4px;
      }

      .chat-footer {
        padding: 0.6rem 0.6rem 0.7rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }

      .chat-form {
        display: flex;
        gap: 0.5rem;
      }

      .chat-input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0.4rem 0.9rem;
        background: rgba(0, 0, 0, 0.2);
        color: #f7f7fb;
        font-size: 0.9rem;
        outline: none;
      }

      .chat-input:focus {
        border-color: #7a5cff;
        box-shadow: 0 0 0 1px rgba(122, 92, 255, 0.6);
      }

      .chat-send {
        border-radius: 999px;
        border: none;
        padding: 0.4rem 0.95rem;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        cursor: pointer;
        background: linear-gradient(135deg, #ffb347, #ff8a52);
        color: #1b1309;
      }

      .chat-send:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .chat-status {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        opacity: 0.7;
        min-height: 1em;
      }
    </style>
  </head>
  <body>
    <div class="chat-shell">
      <header class="chat-header">
        <div class="chat-avatar">
          <div class="chat-avatar-inner"></div>
        </div>
        <div>
          <div id="heading" class="chat-title">Armonia • AI Assistant</div>
          <div class="chat-subtitle">Ask about recording, mixing, and more.</div>
        </div>
      </header>

      <div id="chat-log" class="chat-log"></div>

      <footer class="chat-footer">
        <form id="chat-form" class="chat-form">
          <input
            id="chat-input"
            class="chat-input"
            type="text"
            autocomplete="off"
            placeholder="Ask Armonia about your track..."
          />
          <button id="chat-send" class="chat-send" type="submit">Send</button>
        </form>
        <div id="chat-status" class="chat-status"></div>
      </footer>
    </div>

    <script>
      const headingEl = document.getElementById("heading");
      const chatLog = document.getElementById("chat-log");
      const form = document.getElementById("chat-form");
      const input = document.getElementById("chat-input");
      const statusEl = document.getElementById("chat-status");
      const sendBtn = document.getElementById("chat-send");

      // Keep conversation on the client; we send it to the Worker each turn.
      const history = [];

      function appendMessage(role, text) {
        const row = document.createElement("div");
        row.className = `msg-row ${role}`;

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        bubble.textContent = text;

        row.appendChild(bubble);
        chatLog.appendChild(row);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      async function sendMessage(message) {
        statusEl.textContent = "Thinking…";
        sendBtn.disabled = true;

        try {
          const resp = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history, message }),
          });

          if (!resp.ok) {
            const errText = await resp.text();
            statusEl.textContent = "Error from worker.";
            console.error("Chat error:", errText);
            return;
          }

          const data = await resp.json();
          const answer = data.answer ?? "[No answer field returned]";

          // Update history we send on subsequent turns
          history.push({ role: "user", content: message });
          history.push({ role: "assistant", content: answer });

          appendMessage("assistant", answer);
          statusEl.textContent = "";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Network error.";
        } finally {
          sendBtn.disabled = false;
        }
      }

      // Initial heading from /message (optional, but mirrors the old example)
      fetch("/message")
        .then((resp) => resp.text())
        .then((text) => {
          if (text && text.trim()) {
            headingEl.textContent = text;
          }
        })
        .catch(() => {});

      // Start with a friendly assistant greeting
      appendMessage(
        "assistant",
        "Hey! I’m Armonia’s built-in assistant. Ask me about recording, mixing, or how to structure your song."
      );

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const value = input.value.trim();
        if (!value) return;

        input.value = "";
        appendMessage("user", value);
        sendMessage(value);
      });
    </script>
  </body>
</html>
